package umu.tds.modelo;


import java.util.Arrays;
import java.util.HashMap;
import java.util.HashSet;
import java.util.LinkedHashSet;
import java.util.LinkedList;
import java.util.List;
import java.util.Set;
import java.util.stream.Collectors;

import umu.tds.persistencia.DAOException;
import umu.tds.persistencia.FactoriaDAO;

public class CatalogoCanciones {

	private static CatalogoCanciones unicaInstancia = null;
	private FactoriaDAO factoria;
	
	
	public static CatalogoCanciones getUnicaInstancia() {
		if (unicaInstancia == null) unicaInstancia = new CatalogoCanciones();
		return unicaInstancia;
	}
	
	private HashMap<Integer, Cancion> cancionesPorID;
	
	
	private CatalogoCanciones (){
		
		cancionesPorID = new HashMap<Integer, Cancion>();
		
		try {
			factoria = FactoriaDAO.getInstancia();
			
			List<Cancion> listaCanciones = factoria.getCancionDAO().recuperarTodasCanciones();
			for (Cancion cancion : listaCanciones) {
				cancionesPorID.put(cancion.getCodigo(), cancion);
				
			}
		} catch (DAOException eDAO) {
			   eDAO.printStackTrace();
		}
	}
	
	
	public List<Cancion> getCanciones() throws DAOException {
		return new LinkedList<Cancion>(cancionesPorID.values());
	}
	
	// Cancion recuperar cancion
	public Cancion getCancion(int id) {
		return cancionesPorID.get(id);
	}
	// Aniadir una cancion
	public void addCancion(Cancion cancion) {
		cancionesPorID.put(cancion.getCodigo(), cancion);
		
	}
	// Eliminar una cancion del catalogo
	public void removeCancion(Cancion cancion) {
		cancionesPorID.remove(cancion.getCodigo());
		
	}
	// Comprobar si la variable es igual a interprete
	public String comprobarCorrecionInterprete(String interprete) {
		if (interprete.equals("INTERPRETE")) {
			return null;
		}
		return interprete;
	}
	
	// Comprobar si la variable de texto es igual a titulo
	public String comprobarCorrecionTitulo(String titulo) {
		if (titulo.equals("TITULO")) {
			return null;
		}
		return titulo;
	}
	
	// Metodos auxiliares
	public Set<Cancion> listToSet(List<Cancion> l){
		return new LinkedHashSet<Cancion>(l);
	}
	public List<Cancion> setToList(Set<Cancion> s){
		return new LinkedList<Cancion>(s); 
	}
	
	// Eliminar las canciones repetidas
	public List<Cancion> rmRepetidas(List<Cancion> l){
		return setToList(listToSet(l));
	}
	
	public Set<String> genSetFromString(String conjuntoAutores){
		return new HashSet<String>(Arrays.asList(conjuntoAutores.split(",")));
	}
	
	public List<Cancion> filtrarCanciones(String interprete, String titulo, String estilo, List<Cancion> todasCanciones){
		List<Cancion> resultado = new LinkedList<Cancion>();
		if(titulo != null)
			todasCanciones = todasCanciones.stream().filter(c -> c.getTitulo().contains(titulo)).collect(Collectors.toList());
		if(estilo != null)
			todasCanciones = todasCanciones.stream().filter(c -> c.getEstiloMusical().contains(estilo)).collect(Collectors.toList());
		if(interprete != null) {
			Set<String> autores = this.genSetFromString(interprete);
			for (Cancion c : todasCanciones) {
				if(c.getListaInterpretes().stream().collect(Collectors.toSet()).containsAll(autores)
						|| c.getListaInterpretes().stream().filter(a -> a.contains(interprete)).collect(Collectors.toList()).size() > 0)
					resultado.add(c);
			}
			return resultado;
		}
		resultado = todasCanciones;
		return resultado;
	}	
	
	
}
